--------------------------------------------------------------------
-- DURABILITY
--------------------------------------------------------------------

local DuraFrame = CreateFrame('Frame')
DuraFrame:EnableMouse(true)
DuraFrame:SetFrameStrata('MEDIUM')
DuraFrame:SetFrameLevel(3)

L.Slots = {
	[1] = {1, "Head", 1000},
	[2] = {3, "Shoulder", 1000},
	[3] = {5, "Chest", 1000},
	[4] = {6, "Waist", 1000},
	[5] = {9, "Wrist", 1000},
	[6] = {10, "Hands", 1000},
	[7] = {7, "Legs", 1000},
	[8] = {8, "Feet", 1000},
	[9] = {16, "Main Hand", 1000},
	[10] = {17, "Off Hand", 1000},
	[11] = {18, "Ranged", 1000}
}

Dura = DuraFrame:CreateFontString(nil, 'OVERLAY')
Dura:SetFont(LanConfig.Media.Font, 8)
Dura:SetHeight(12)
Dura:SetWidth(60)
Dura:SetPoint('TOPRIGHT', DataFeed, -1, -1)
Dura:SetShadowColor(0, 0, 0, 0.4)
Dura:SetShadowOffset(1, -1)

local Total = 0
local current, max
local playerColor = RAID_CLASS_COLORS[select(2, UnitClass('player'))]
local classColor = LanFunc.RGBToHex(playerColor.r, playerColor.g, playerColor.b)

local function OnEvent(self)
    for i = 1, 11 do
        if GetInventoryItemLink('player', L.Slots[i][1]) ~= nil then
            current, max = GetInventoryItemDurability(L.Slots[i][1])
            if current then 
                L.Slots[i][3] = current/max
                Total = Total + 1
            end
        end
    end
    table.sort(L.Slots, function(a, b) return a[3] < b[3] end)
    
    if Total > 0 then
        Dura:SetText(classColor..'Armor:|r '..floor(L.Slots[1][3]*100)..'%')
    else
        Dura:SetText(classColor..'Armor:|r 100%')
    end
    -- Setup Durability Tooltip
    self:SetAllPoints(Dura)
    Total = 0
end

DuraFrame:RegisterEvent('UPDATE_INVENTORY_DURABILITY')
DuraFrame:RegisterEvent('MERCHANT_SHOW')
DuraFrame:RegisterEvent('PLAYER_ENTERING_WORLD')
DuraFrame:SetScript('OnMouseDown', function() ToggleCharacter('PaperDollFrame') end)
DuraFrame:SetScript('OnEvent', OnEvent)
DuraFrame:SetScript('OnEnter', function(self)
    if not InCombatLockdown() then
        GameTooltip:SetOwner(self, 'ANCHOR_TOP', 0, 4)
        GameTooltip:ClearAllPoints()
        GameTooltip:SetPoint('BOTTOM', self, 'TOP', 0, 1)
        GameTooltip:ClearLines()
        for i = 1, 11 do
            if L.Slots[i][3] ~= 1000 then
                green = L.Slots[i][3]*2
                red = 1 - green
                GameTooltip:AddDoubleLine(L.Slots[i][2], floor(L.Slots[i][3]*100)..'%',1 ,1 , 1, red + 1, green, 0)
            end
        end
        GameTooltip:Show()
    end
end)
DuraFrame:SetScript('OnLeave', function() GameTooltip:Hide() end)